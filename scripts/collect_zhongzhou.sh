#!/usr/bin/env bash
set -euo pipefail

PROJECT_NAME="zhongzhou-smart-care"
EXPORT_DIR="${EXPORT_DIR:-/root/${PROJECT_NAME}}"
DATE_STR="$(date +%Y%m%d)"

TOMCAT_DIR="/opt/apache-tomcat-9.0.100"
NGINX_CONF_DIR="/etc/nginx"
NGINX_HTML_DIR="/var/www/dist"

NODE2_HOST="192.168.88.102"
NODE3_HOST="192.168.88.103"

SSH_OPTS=(-o BatchMode=yes -o StrictHostKeyChecking=accept-new)

GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

log() {
  echo -e "${BLUE}$*${NC}"
}

step() {
  echo -e "\n${GREEN}$*${NC}"
}

warn() {
  echo -e "${RED}$*${NC}"
}

log "ðŸš€ å¼€å§‹æ‰§è¡Œä¸­å·žå…»è€é¡¹ç›®èµ„äº§æ”¶é›†ä»»åŠ¡..."
log "ðŸ“‚ ç›®æ ‡ä»“åº“ç›®å½•: ${EXPORT_DIR}"

mkdir -p "${EXPORT_DIR}"/{scripts,conf,sql,logs_sample,docs,ansible}
mkdir -p "${EXPORT_DIR}/conf"/{node1_mysql,node1_redis,node1_nginx,node2_tomcat,node3_nginx}

step "--> [Node1] æ­£åœ¨æ”¶é›†æœ¬åœ°é…ç½®..."

echo "æ­£åœ¨æœç´¢å¹¶å¤åˆ¶ Shell è„šæœ¬..."
find /root -maxdepth 2 -name "*.sh" -not -name "collect_zhongzhou.sh" -exec cp {} "${EXPORT_DIR}/scripts/" \; 2>/dev/null || true
if [ -d "/export/shell" ]; then
  cp -r /export/shell/* "${EXPORT_DIR}/scripts/" 2>/dev/null || true
fi

crontab -l > "${EXPORT_DIR}/conf/node1_crontab.txt" 2>/dev/null || true

echo "æ”¶é›† Node1 Nginx é…ç½®..."
if [ -d "${NGINX_CONF_DIR}" ]; then
  cp "${NGINX_CONF_DIR}/nginx.conf" "${EXPORT_DIR}/conf/node1_nginx/" 2>/dev/null || true
  cp -r "${NGINX_CONF_DIR}/conf.d" "${EXPORT_DIR}/conf/node1_nginx/" 2>/dev/null || true
fi

if [ -f "/etc/my.cnf" ]; then
  cp /etc/my.cnf "${EXPORT_DIR}/conf/node1_mysql/" 2>/dev/null || true
fi

step "--> MySQL Schema (ä»…ç»“æž„)"
if command -v mysqldump &> /dev/null; then
  if [ -n "${MYSQL_DEFAULTS_FILE:-}" ] && [ -f "${MYSQL_DEFAULTS_FILE}" ]; then
    mysqldump --defaults-extra-file="${MYSQL_DEFAULTS_FILE}" --all-databases --no-data > "${EXPORT_DIR}/sql/db_schema.sql" || true
  elif [ -n "${MYSQL_DUMP_PASSWORD:-}" ]; then
    mysqldump -uroot -p"${MYSQL_DUMP_PASSWORD}" --all-databases --no-data > "${EXPORT_DIR}/sql/db_schema.sql" || true
  else
    warn "âš ï¸  æœªæä¾› MySQL å‡­æ®ï¼Œè·³è¿‡ Schema å¯¼å‡ºã€‚"
  fi
else
  warn "âš ï¸  æœªæ‰¾åˆ° mysqldumpï¼Œè·³è¿‡ Schema å¯¼å‡ºã€‚"
fi

if [ -d "/etc/ansible" ]; then
  cp /etc/ansible/ansible.cfg "${EXPORT_DIR}/ansible/" 2>/dev/null || true
  cp /etc/ansible/hosts "${EXPORT_DIR}/ansible/inventory" 2>/dev/null || true
  if [ -d "/root/ansible" ]; then
    cp -r /root/ansible/* "${EXPORT_DIR}/ansible/" 2>/dev/null || true
  fi
fi

step "--> [Node2] æ­£åœ¨è¿œç¨‹æ”¶é›† Tomcat/Java é…ç½®..."
ssh "${SSH_OPTS[@]}" "root@${NODE2_HOST}" "mkdir -p /tmp/collect_node2" || true
scp "root@${NODE2_HOST}:${TOMCAT_DIR}/conf/server.xml" "${EXPORT_DIR}/conf/node2_tomcat/" 2>/dev/null || true
scp "root@${NODE2_HOST}:${TOMCAT_DIR}/conf/context.xml" "${EXPORT_DIR}/conf/node2_tomcat/" 2>/dev/null || true
ssh "${SSH_OPTS[@]}" "root@${NODE2_HOST}" "tail -n 50 ${TOMCAT_DIR}/logs/catalina.out" > "${EXPORT_DIR}/logs_sample/node2_tomcat_sample.log" 2>/dev/null || true

step "--> [Node3] æ­£åœ¨è¿œç¨‹æ”¶é›† Nginx é…ç½®ä¸Žå‰ç«¯èµ„æºç›®å½•..."
scp "root@${NODE3_HOST}:${NGINX_CONF_DIR}/nginx.conf" "${EXPORT_DIR}/conf/node3_nginx/" 2>/dev/null || true
scp -r "root@${NODE3_HOST}:${NGINX_CONF_DIR}/conf.d" "${EXPORT_DIR}/conf/node3_nginx/" 2>/dev/null || true
ssh "${SSH_OPTS[@]}" "root@${NODE3_HOST}" "tree -L 2 ${NGINX_HTML_DIR}" > "${EXPORT_DIR}/docs/node3_html_tree.txt" 2>/dev/null || true

step "--> æ­£åœ¨ç”Ÿæˆé¡¹ç›®æ–‡æ¡£..."
cat > "${EXPORT_DIR}/README.md" <<'DOC'
# ðŸ¥ ä¸­å·žå…»è€ (Zhongzhou Smart Care) - è¿ç»´å®žæˆ˜é¡¹ç›®

> è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ CentOS çš„åˆ†å¸ƒå¼å¾®æœåŠ¡æž¶æž„éƒ¨ç½²é¡¹ç›®æ”¶é›†åŒ…ã€‚
> åŒ…å« Nginxã€Tomcatã€MySQLã€Redisã€Ansible ç­‰æ ¸å¿ƒèµ„äº§ï¼Œç”¨äºŽä½œå“é›†å±•ç¤ºä¸Žå¤ç›˜ã€‚

## ðŸ“‚ é¡¹ç›®ç»“æž„

```text
.
â”œâ”€â”€ ansible/        # è‡ªåŠ¨åŒ–éƒ¨ç½²å‰§æœ¬
â”œâ”€â”€ conf/           # å„èŠ‚ç‚¹æ ¸å¿ƒé…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/        # è¿ç»´ Shell è„šæœ¬
â”œâ”€â”€ sql/            # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ (Schema)
â”œâ”€â”€ logs_sample/    # è¿è¡Œæ—¥å¿—æ ·æœ¬
â””â”€â”€ docs/           # é¡¹ç›®æ–‡æ¡£ä¸Žæž¶æž„è¯´æ˜Ž
```

## ðŸ—ï¸ æž¶æž„è¯´æ˜Ž

* **Node1 (Manager/DB)**: MySQLã€Redisã€Ansible æŽ§åˆ¶ç«¯
* **Node2 (App)**: Tomcat (åŽç«¯ Java API)
* **Node3 (Web/LB)**: Nginx (å‰ç«¯é™æ€èµ„æº + åå‘ä»£ç†)

---
*Generated by Hai Ting's Ops Collection Script*
DOC

cat > "${EXPORT_DIR}/.gitignore" <<'DOC'
*.log
*.tar.gz
*.zip
.DS_Store
passwords.txt
id_rsa
DOC

log "âœ… æ”¶é›†å®Œæˆï¼š${EXPORT_DIR}"
log "ðŸ’¡ å»ºè®®ï¼šäººå·¥æ£€æŸ¥ SQL/æ•æ„Ÿä¿¡æ¯åŽå†ä¸Šä¼  GitHubã€‚"

